CREATE MEMORY TABLE granularity(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
	name VARCHAR(100))

CREATE MEMORY TABLE kpi_agg_type(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
	aggregation VARCHAR(100) NOT NULL)

CREATE MEMORY TABLE sensor(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	name VARCHAR(45) NOT NULL,
	sampling_rate INTEGER NOT NULL,
	sampling_interval VARCHAR(45) NOT NULL)

CREATE MEMORY TABLE shift(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	name VARCHAR(45) DEFAULT NULL)
	
CREATE MEMORY TABLE machine(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	name VARCHAR(45) DEFAULT NULL)
	
CREATE MEMORY TABLE product(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	name VARCHAR(60) DEFAULT NULL,
	code VARCHAR(45) DEFAULT NULL)
	
CREATE MEMORY TABLE mould(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	product_id INTEGER NOT NULL,
	name VARCHAR(60) DEFAULT NULL,
	code VARCHAR(45) DEFAULT NULL,
	cycle INTEGER DEFAULT NULL,
	CONSTRAINT kpi_values_mould_fk FOREIGN KEY(product_id) REFERENCES product(id) ON DELETE CASCADE ON UPDATE CASCADE)
	
CREATE MEMORY TABLE kpi(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	parent_id INTEGER DEFAULT NULL,
	name VARCHAR(45) NOT NULL,
	description VARCHAR(255) DEFAULT NULL,
	sampling_rate INTEGER DEFAULT 1,
	sampling_interval VARCHAR(45) DEFAULT 'hour',
	context_product BIT(1) DEFAULT B'0',
	context_machine BIT(1) DEFAULT B'0',
	context_mould BIT(1) DEFAULT B'0',
	context_shift BIT(1) DEFAULT B'0',
	calculation_type VARCHAR(45) NOT NULL,
	aggregation INTEGER,
	number_support VARCHAR(50) DEFAULT NULL,
	number_support_format VARCHAR(50) DEFAULT 'DECIMAL',
	active BOOLEAN DEFAULT TRUE,
	CONSTRAINT parent_kpi FOREIGN KEY(parent_id) REFERENCES kpi(id) ON DELETE SET NULL ON UPDATE CASCADE,
	CONSTRAINT kpi_kpi_agg_type_FK FOREIGN KEY(aggregation) REFERENCES kpi_agg_type(id))

CREATE MEMORY TABLE kpi_formula(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	kpi_id INTEGER NOT NULL,
	term1_kpi_id INTEGER DEFAULT NULL,
	term1_sensor_id INTEGER DEFAULT NULL,
	operator_1 VARCHAR(45) DEFAULT NULL,
	term2_kpi_id INTEGER DEFAULT NULL,
	term2_sensor_id INTEGER DEFAULT NULL,
	operator_2 VARCHAR(45) DEFAULT NULL,
	term3_kpi_id INTEGER DEFAULT NULL,
	term3_sensor_id INTEGER DEFAULT NULL,
	criteria VARCHAR(45) DEFAULT NULL,
	CONSTRAINT formula_kpi_id FOREIGN KEY(kpi_id) REFERENCES kpi(id),
	CONSTRAINT term1_kpi FOREIGN KEY(term1_kpi_id) REFERENCES kpi(id),
	CONSTRAINT term2_kpi FOREIGN KEY(term2_kpi_id) REFERENCES kpi(id),
	CONSTRAINT term3_kpi FOREIGN KEY(term3_kpi_id) REFERENCES kpi(id),
	CONSTRAINT term1_sensor FOREIGN KEY(term1_sensor_id) REFERENCES sensor(id),
	CONSTRAINT term2_sensor FOREIGN KEY(term2_sensor_id) REFERENCES sensor(id),
	CONSTRAINT term3_sensor FOREIGN KEY(term3_sensor_id) REFERENCES sensor(id))
	
CREATE MEMORY TABLE kpi_target(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
	kpi_id INTEGER DEFAULT NULL,
	product_id INTEGER DEFAULT NULL,
	mould_id INTEGER DEFAULT NULL,
	machine_id INTEGER DEFAULT NULL,
	shift_id INTEGER DEFAULT NULL,
	lower_bound DOUBLE DEFAULT NULL,
	upper_bound DOUBLE DEFAULT NULL,
	CONSTRAINT target_kpi FOREIGN KEY(kpi_id) REFERENCES kpi(id) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT target_machine FOREIGN KEY(machine_id) REFERENCES machine(id) ON DELETE SET NULL ON UPDATE CASCADE,
	CONSTRAINT target_mould FOREIGN KEY(mould_id) REFERENCES mould(id) ON DELETE SET NULL ON UPDATE CASCADE,
	CONSTRAINT target_product FOREIGN KEY(product_id) REFERENCES product(id) ON DELETE SET NULL ON UPDATE CASCADE,
	CONSTRAINT target_shift FOREIGN KEY(shift_id) REFERENCES shift(id) ON DELETE SET NULL ON UPDATE CASCADE)
	
CREATE MEMORY TABLE kpi_values(
	id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
	kpi_timestmp TIMESTAMP,
	kpi_id INTEGER NOT NULL,
	machine_id INTEGER,
	kpi_value DECIMAL(13,4),
	product_id INTEGER,
	mould_id INTEGER,
	shift_id INTEGER,
	granularity_id INTEGER)